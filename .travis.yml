language: android
env:
  global:
  - MALLOC_ARENA_MAX=2
  - secure: gKWVu6Ub6LKVtt+d+qKWg5TMqmRL5OmyPdEXZBWkc9yEzcb3QGTPAUoZU7Q0/5g94mbqroWyEMnCo/cta1ZSL1laGVNN4RX6FVlk7RyDWpL1KB+jTjaskti0hUvXMWOSEs9/3Q2NFmGcHreNMadAFa+mIH90njWipWCyERx7XUttpYQxKgS3SV62Bci0impfq9E2d6Loj0O4Mo0MujcYo3A6nZ36Xtjwmbqo+/GyQrFo46CxdgOQxmN0aesSF/HY5us3AO2SOM4+6KjdPzROesID++SYTpBcmqf4f3Xt7upz5ljmBdn9D1mKkClAqlQWLZixP9Ctjlh5X0SGGRx5h4xFBg2L297m0aeCX+NrQHLqagugU3OP33uLFh3VejPumLJ7b/rJbxKp/ZrN+GjEhaSEkUgND32LwLa02Fpq/6HxNS+tuKSwtvcjqGJ6BoRE6R6XThyzoGVXhfLtoHqdo6Na0n/TfdC9nczOthFPHnXT7conQWgly3+SuUBsW51WMGZgp12Yn/nT3ke6mlUlPdI56HRy25JDpM6ii9o6cxAt7z4lxuctLfLqId7O/9L78IXPYJPqwxWLbHtxPTb/AaOTiK3qozhHRF7Oqcq8aYcEjoARGylqA+grMXihhCEne9ETUtKSt5yxiWW2gHkanUK5ZfUehk5v68tWD6i7OHA=
  - secure: lrnzhMmgnUzBW9jmcKdSBtdKc1llI1LcUXLeOeAfimzNMJUCQzGtY7unSbxZ28bc9l/qAjYkoDcHqjhhLk55jg4gcxHfkGj6WhxIg0xpTixh/iSjNvg8X59yntUsQt1f4/Xh/f3K9YSnmVbLN+DaBlAuilMr0CQZDfne90HVqK1Vu1RuojGKYMHGCH80Ic1FCvYRb7JMq6vB8l0OI0o9UldQajWJN0icM1826G1V/gFVW4MUhcOEGqpxVchCF9n8ucR5vxgtvv+bRpPxrfVINPQEMTiu7OpadoSCEWuBTg1ZJYF2Et/CRdq2vhp+GtDk3/RdFrKuqv7SqxwCsq258kE7lbAOPi5w81b0LiXq4XknCy2G2qyoU2KMI5tGmtPB4aIyH1mXAu1uykzqJc511ZlLfB2OK2DpJEoxlNJ1VnBFlJLmCSVQjVV9xgaZ35V/0KWo0QCOzTTmg38u5y/jC+2q4PL/qFz+1N8nXMXYxXKgZRWT2lY1rJXBvLo5//nzw06vnqGA1DRMQ+Y1ymHXY5beqj450/R2bKOVtb8312uJ3katdLbp8g9lkuMPCfMR+y8MLjLa2wXx5gp2yebqAzf81fVAhYiIlOpSRpz+uQGEz1y1Pd6okLiEIE7uqO8UuBeIwQlD+ThuylIlTV2G8tBnuq5CDu7Ejhy/hUiWbVU=
  - secure: ZRAQk9vlnXcuD4/964/Vwvx9RinXoIrBzMeZ9vj5dxGIrvTB0gCkHzVxTx/A/O2tHjUC0fhJPfbMUqDE/O9nJZMMknCGuJ6+c84aSqTfcXm8rqZ4Z1jIPbDAxuPNHl5WzO7N6O96CiXvkkLdgZGn85SbrhatOKpoyhHUkosEkxyrDpz2bbM2pYw07ynUWDvm0/lN9gg9iVqmHwLSYghCka3G01CLqXT7fcEqUUnuHnu+jHHHD3MWFH6+nZaZrU5hfh065T5bom45a4ZIK0gsEpar06kc35vRrDfGqIW3TW2hLpT4hC/lpiq/pcWZEdZYOxYKWd/aNKmiMKVu2hUE+BLI1n+AP8Ma1ddgTKXQpnBtWfMJ+0EfY1X9TbKuvC/DZBtmluZ7Px3n5irDl6ABnh9hgjpe0X1d26dXygBIvP4ZrDhIEZrAAuaFMJBJ/zRLjd48nwCDIMj/GG3jpEkNJd5E1erSRACzo5JTT+QSsOIeFdx+nETcmpXUPhbx00jN6R3l2v4AqWJl5vC4tOL545Qt/LxbZIxuq/g9inj8u2BAJ9gagmSwWfwucqHMNc55f2PjlwwXlRZ+6m7Xr+nwr1Kpw4rDLnKuSmLmRY/sIMLsgjaWMGNA9s+hTd+9/rfYbLR9fyY8klyAjDlHG4RwuXFcXEA056r/6oRavABZJv0=
  matrix:
  - ANDROID_SDKS=android-19,sysimg-19 ANDROID_TARGET=android-19 ANDROID_ABI=armeabi-v7a
    ENABLE_GPL_THIRD_PARTIES=0 BUILD_VIDEO=1 BUILD_OPENH264=1 ENABLE_OPENH264_DECODER=1
    BUILD_X264=0 BUILD_AMRNB=full BUILD_AMRWB=1 BUILD_ZRTP=1 BUILD_SILK=1 BUILD_G729=1
    BUILD_TUNNEL=0 BUILD_WEBRTC_AECM=1 USE_JAVAH=1 BUILD_FOR_X86=1 BUILD_SQLITE=1
    BUILD_TLS=1 BUILD_WEBRTC_ISAC=1 BUILD_OPUS=1 BUILD_UPNP=1 BUILD_MATROSKA=0 BUILD_ILBC=1
sudo: false
addons:
  apt:
    packages:
    - yasm
    - nasm
    - curl
    - ant
    - rsync
    - autoconf
    - automake
    - libtool
    - pkg-config
    - bc
    - libwww-perl
    - ruby
cache:
  apt: true
  bundler: true
  ccache: true
  directories:
  - "$HOME/.ccache"
before_install:
- if [ `uname -m` = x86_64 ]; then wget --timeout=120 http://dl.google.com/android/ndk/android-ndk-r10e-linux-x86_64.bin
  -O ndk.bin ; else wget --timeout=120 http://dl.google.com/android/ndk/android-ndk-r10e-linux-x86.bin
  -O ndk.bin ; fi
- chmod 755 ndk.bin ; ./ndk.bin 2>&1 | grep -v Extracting
- export ANDROID_NDK=$PWD/android-ndk-r10e
- export PATH=${ANDROID_NDK}:${ANDROID_NDK}/ndk-build:${ANDROID_HOME}/tools:${ANDROID_HOME}/platform-tools:$PATH
- export NDK_CACHE=ccache
- export ANDROID_MOST_RECENT_TARGET=android-19
- which bundler || gem install bundler
- bundle install
android:
  components:
  - build-tools-19.1.0
  - build-tools-20.0.0
  - build-tools-22.0.1
  - android-19
  - android-20
  - android-22
  - extra-google-google_play_services
  - extra-google-m2repository
  - extra-android-m2repository
  - addon-google_apis-google-19
  - addon-google_apis-google-20
  - addon-google_apis-google-22
before_script:
- echo "Starting to update submodules"
- if [ ! -d submodules/linphone/oRTP/.git ]; then rm -fr submodules/linphone/oRTP/
  ; git clone git://git.linphone.org/ortp.git submodules/linphone/oRTP ; fi
- if [ ! -d submodules/linphone/mediastreamer2/.git ]; then rm -fr submodules/linphone/mediastreamer2/
  ; git clone git://git.linphone.org/mediastreamer2.git submodules/linphone/mediastreamer2
  ; fi
- if [ ! -d submodules/mswebrtc/webrtc/.git ]; then rm -fr submodules/mswebrtc/webrtc/
  ; git clone git://git.linphone.org/webrtc.git submodules/mswebrtc/webrtc ; fi
- git submodule update --init --recursive
- echo "Finished updating submodules"
- android list target -c
script:
- "./Tools/prepare_crashlytics.sh"
- "./Tools/travis_script.sh"
- find . -name '*.apk' -print
before_cache:
- echo "before_cache"
after_success:
- echo "after_success"
- "./Tools/github_release.sh"
after_failure:
- echo "after_failure"
after_script:
- echo "after_script"
notifications:
  slack:
    secure: PbV38W/sM4KC9zan3fNkMhqOl9uISNkqtmqrKruuNXMM0uOXEmAP57cyHP3k8B2UEAECXVRRmD3VtVJmQt+y9abaR1YUIRdMlRgkSoXmy4vAVh9tveZvNkohFzlfNCLS4oGiT/bodCuLpVP7AwT97l0eRZXABCx1+x0Ju7sHyXA=
  flowdock:
    secure: RGcyuffpq84c1ku6htGkmDnnwvcI/xQreEDowCGVzYPa2ih5birV3GayMMaZoxG+Xpc9Qjkq5wm5wwsqzMQMryg2SesqHZ22tdDLT8oKEmNdZRoUKr6PjJPbcy+YCrNXcqP3fWUNd0FfApiDOMM7q+CI7yl49auJigE0wOKG4Z4=
